"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[5360],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>h});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),m=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},c=function(e){var t=m(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=m(a),u=i,h=p["".concat(l,".").concat(u)]||p[u]||d[u]||o;return a?n.createElement(h,r(r({ref:t},c),{},{components:a})):n.createElement(h,r({ref:t},c))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:i,r[1]=s;for(var m=2;m<o;m++)r[m]=a[m];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},5960:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>m});var n=a(7462),i=(a(7294),a(3905));const o={},r="Migrations",s={unversionedId:"docs/Advanced/Migrations",id:"docs/Advanced/Migrations",title:"Migrations",description:"Schema migrations is the mechanism by which you can add new tables and columns to the database in a backward-compatible way.",source:"@site/docs/docs/Advanced/Migrations.md",sourceDirName:"docs/Advanced",slug:"/docs/Advanced/Migrations",permalink:"/docs/Advanced/Migrations",draft:!1,editUrl:"https://github.com/nozbe/WatermelonDB/edit/master/docs-website/docs/docs/Advanced/Migrations.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Model",permalink:"/docs/Model"},next:{title:"Relations",permalink:"/docs/Relation"}},l={},m=[{value:"Migrations setup",id:"migrations-setup",level:2},{value:"Migrations workflow",id:"migrations-workflow",level:2},{value:"Step 1: Add a new migration",id:"step-1-add-a-new-migration",level:3},{value:"Step 2: Make matching changes in schema",id:"step-2-make-matching-changes-in-schema",level:3},{value:"Step 3: Bump schema version",id:"step-3-bump-schema-version",level:3},{value:"Step 4: Test your migrations",id:"step-4-test-your-migrations",level:3},{value:"Why is this order important",id:"why-is-this-order-important",level:3},{value:"Migrations API",id:"migrations-api",level:2},{value:"Migration steps:",id:"migration-steps",level:3},{value:"Database reseting and other edge cases",id:"database-reseting-and-other-edge-cases",level:2},{value:"Rolling back changes",id:"rolling-back-changes",level:3},{value:"Unsafe SQL migrations",id:"unsafe-sql-migrations",level:3}],c={toc:m};function p(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"migrations"},"Migrations"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Schema migrations")," is the mechanism by which you can add new tables and columns to the database in a backward-compatible way."),(0,i.kt)("p",null,"Without migrations, if a user of your app upgrades from one version to another, their local database will be cleared at launch, and they will lose all their data."),(0,i.kt)("p",null,"\u26a0\ufe0f Always use migrations!"),(0,i.kt)("h2",{id:"migrations-setup"},"Migrations setup"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add a new file for migrations:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// app/model/migrations.js\n\nimport { schemaMigrations } from '@nozbe/watermelondb/Schema/migrations'\n\nexport default schemaMigrations({\n  migrations: [\n    // We'll add migration definitions here later\n  ],\n})\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Hook up migrations to the Database adapter setup:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// index.js\nimport migrations from 'model/migrations'\n\nconst adapter = new SQLiteAdapter({\n  schema: mySchema,\n  migrations,\n})\n")))),(0,i.kt)("h2",{id:"migrations-workflow"},"Migrations workflow"),(0,i.kt)("p",null,"When you make schema changes when you use migrations, be sure to do this in this specific order, to minimize the likelihood of making an error."),(0,i.kt)("h3",{id:"step-1-add-a-new-migration"},"Step 1: Add a new migration"),(0,i.kt)("p",null,"First, define the migration - that is, define the ",(0,i.kt)("strong",{parentName:"p"},"change")," that occurs between two versions of schema (such as adding a new table, or a new table column)."),(0,i.kt)("p",null,"Don't change the schema file yet!"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// app/model/migrations.js\n\nimport { schemaMigrations, createTable } from '@nozbe/watermelondb/Schema/migrations'\n\nexport default schemaMigrations({\n  migrations: [\n    {\n      // \u26a0\ufe0f Set this to a number one larger than the current schema version\n      toVersion: 2,\n      steps: [\n        // See \"Migrations API\" for more details\n        createTable({\n          name: 'comments',\n          columns: [\n            { name: 'post_id', type: 'string', isIndexed: true },\n            { name: 'body', type: 'string' },\n          ],\n        }),\n      ],\n    },\n  ],\n})\n")),(0,i.kt)("p",null,"Refresh your simulator/browser. You should see this error:"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Migrations can't be newer than schema. Schema is version 1 and migrations cover range from 1 to 2")),(0,i.kt)("p",null,"If so, good, move to the next step!"),(0,i.kt)("p",null,'But you might also see an error like "Missing table name in schema", which means you made an error in defining migrations. See ',(0,i.kt)("a",{parentName:"p",href:"#migrations-api"},'"Migrations API" below')," for details."),(0,i.kt)("h3",{id:"step-2-make-matching-changes-in-schema"},"Step 2: Make matching changes in schema"),(0,i.kt)("p",null,"Now it's time to make the actual changes to the schema file \u2014 add the same tables or columns as in your migration definition"),(0,i.kt)("p",null,"\u26a0\ufe0f Please double and triple check that your changes to schema match exactly the change you defined in the migration. Otherwise you risk that the app will work when the user migrates, but will fail if it's a fresh install \u2014 or vice versa."),(0,i.kt)("p",null,"\u26a0\ufe0f Don't change the schema version yet"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// model/schema.js\n\nexport default appSchema({\n  version: 1,\n  tables: [\n    // This is our new table!\n    tableSchema({\n      name: 'comments',\n      columns: [\n        { name: 'post_id', type: 'string', isIndexed: true },\n        { name: 'body', type: 'string' },\n      ],\n    }),\n    // ...\n  ]\n})\n")),(0,i.kt)("p",null,'Refresh the simulator. You should again see the same "Migrations can\'t be newer than schema" error. If you see a different error, you made a syntax error.'),(0,i.kt)("h3",{id:"step-3-bump-schema-version"},"Step 3: Bump schema version"),(0,i.kt)("p",null,"Now that we made matching changes in the schema (source of truth about tables and columns) and migrations (the change in tables and columns), it's time to commit the change by bumping the version:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// model/schema.js\n\nexport default appSchema({\n  version: 2,\n  tables: [\n    // ...\n  ]\n})\n")),(0,i.kt)("p",null,"If you refresh again, your app should show up without issues \u2014 but now you can use the new tables/columns"),(0,i.kt)("h3",{id:"step-4-test-your-migrations"},"Step 4: Test your migrations"),(0,i.kt)("p",null,"Before shipping a new version of the app, please check that your database changes are all compatible:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Migrations test: Install the previous version of your app, then update to the version you're about to ship, and make sure it still works"),(0,i.kt)("li",{parentName:"ol"},"Fresh schema install test: Remove the app, and then install the ",(0,i.kt)("em",{parentName:"li"},"new")," version of the app, and make sure it works")),(0,i.kt)("h3",{id:"why-is-this-order-important"},"Why is this order important"),(0,i.kt)("p",null,"It's simply because React Native simulator (and often React web projects) are configured to automatically refresh when you save a file. You don't want to database to accidentally migrate (upgrade) with changes that have a mistake, or changes you haven't yet completed making. By making migrations first, and bumping version last, you can double check you haven't made a mistake."),(0,i.kt)("h2",{id:"migrations-api"},"Migrations API"),(0,i.kt)("p",null,"Each migration must migrate to a version one above the previous migration, and have multiple ",(0,i.kt)("em",{parentName:"p"},"steps")," (such as adding a new table, or new columns). Larger example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"schemaMigrations({\n  migrations: [\n    {\n      toVersion: 3,\n      steps: [\n        createTable({\n          name: 'comments',\n          columns: [\n            { name: 'post_id', type: 'string', isIndexed: true },\n            { name: 'body', type: 'string' },\n          ],\n        }),\n        addColumns({\n          table: 'posts',\n          columns: [\n            { name: 'subtitle', type: 'string', isOptional: true },\n            { name: 'is_pinned', type: 'boolean' },\n          ],\n        }),\n      ],\n    },\n    {\n      toVersion: 2,\n      steps: [\n        // ...\n      ],\n    },\n  ],\n})\n")),(0,i.kt)("h3",{id:"migration-steps"},"Migration steps:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"createTable({ name: 'table_name', columns: [ ... ] })")," - same API as ",(0,i.kt)("inlineCode",{parentName:"li"},"tableSchema()")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"addColumns({ table: 'table_name', columns: [ ... ] })")," - you can add one or multiple columns to an existing table. The columns table has the same format as in schema definitions"),(0,i.kt)("li",{parentName:"ul"},"Other types of migrations (e.g. deleting or renaming tables and columns) are not yet implemented. See ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/Nozbe/WatermelonDB/blob/master/src/Schema/migrations/index.js"},(0,i.kt)("inlineCode",{parentName:"a"},"migrations/index.js")),". Please contribute!")),(0,i.kt)("h2",{id:"database-reseting-and-other-edge-cases"},"Database reseting and other edge cases"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"When you're ",(0,i.kt)("strong",{parentName:"li"},"not")," using migrations, the database will reset (delete all its contents) whenever you change the schema version."),(0,i.kt)("li",{parentName:"ol"},"If the migration fails, the database will fail to initialize, and will roll back to previous version. This is unlikely, but could happen if you, for example, create a migration that tries to create the same table twice. The reason why the database will fail instead of reset is to avoid losing user data (also it's less confusing in development). You can notice the problem, fix the migration, and ship it again without data loss."),(0,i.kt)("li",{parentName:"ol"},"When database in the running app has ",(0,i.kt)("em",{parentName:"li"},"newer")," database version than the schema version defined in code, the database will reset (clear its contents). This is useful in development"),(0,i.kt)("li",{parentName:"ol"},"If there's no available migrations path (e.g. user has app with database version 4, but oldest migration is from version 10 to 11), the database will reset.")),(0,i.kt)("h3",{id:"rolling-back-changes"},"Rolling back changes"),(0,i.kt)("p",null,'There\'s no automatic "rollback" feature in Watermelon. If you make a mistake in migrations during development, roll back in this order:'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Comment out any changes made to schema.js"),(0,i.kt)("li",{parentName:"ol"},"Comment out any changes made to migrations.js"),(0,i.kt)("li",{parentName:"ol"},"Decrement schema version number (bring back the original number)")),(0,i.kt)("p",null,'After refreshing app, the database should reset to previous state. Now you can correct your mistake and apply changes again (please do it in order described in "Migrations workflow").'),(0,i.kt)("h3",{id:"unsafe-sql-migrations"},"Unsafe SQL migrations"),(0,i.kt)("p",null,"Similar to ",(0,i.kt)("a",{parentName:"p",href:"/docs/Schema"},"Schema"),", you can add ",(0,i.kt)("inlineCode",{parentName:"p"},"unsafeSql")," parameter to every migration step to modify or replace SQL generated by WatermelonDB to perform the migration. There is also an ",(0,i.kt)("inlineCode",{parentName:"p"},"unsafeExecuteSql('some sql;')")," step you can use to append extra SQL. Those are ignored with LokiJSAdapter and for the purposes of ",(0,i.kt)("a",{parentName:"p",href:"/docs/Sync/Intro"},"migration syncs"),"."))}p.isMDXComponent=!0}}]);