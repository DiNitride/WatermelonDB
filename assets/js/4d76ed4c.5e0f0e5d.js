"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[1158],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>k});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(a),c=i,k=u["".concat(s,".").concat(c)]||u[c]||m[c]||r;return a?n.createElement(k,o(o({ref:t},d),{},{components:a})):n.createElement(k,o({ref:t},d))}));function k(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},9664:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var n=a(7462),i=(a(7294),a(3905));const r={},o="Database Adapters",l={unversionedId:"docs/Implementation/DatabaseAdapters",id:"docs/Implementation/DatabaseAdapters",title:"Database Adapters",description:"In this guide, you'll learn how to add support for new databases and new platforms to WatermelonDB.",source:"@site/docs/docs/Implementation/DatabaseAdapters.md",sourceDirName:"docs/Implementation",slug:"/docs/Implementation/DatabaseAdapters",permalink:"/docs/Implementation/DatabaseAdapters",draft:!1,editUrl:"https://github.com/nozbe/WatermelonDB/edit/master/docs-website/docs/docs/Implementation/DatabaseAdapters.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Architecture",permalink:"/docs/Implementation/Architecture"},next:{title:"Publishing WatermelonDB",permalink:"/docs/Implementation/Publishing"}},s={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Currently supported databases",id:"currently-supported-databases",level:2},{value:"SQLite",id:"sqlite",level:3},{value:"LokiJS",id:"lokijs",level:3},{value:"Contribute these adapters!",id:"contribute-these-adapters",level:2},{value:"Adding new React Native operating systems",id:"adding-new-react-native-operating-systems",level:2},{value:"Adding new frameworks to SQLite adapter",id:"adding-new-frameworks-to-sqlite-adapter",level:2},{value:"JS-side glue",id:"js-side-glue",level:3},{value:"Native-side glue",id:"native-side-glue",level:3},{value:"Adding new databases",id:"adding-new-databases",level:2}],d={toc:p};function u(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"database-adapters"},"Database Adapters"),(0,i.kt)("p",null,"In this guide, you'll learn how to add support for new databases and new platforms to WatermelonDB."),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"WatermelonDB is designed to be database-agnostic. It's a frontend JavaScript database framework, but its high-level abstractions can be plugged in to any underlying database, platform, or UI framework. We call the translation layer between underlying databases and high-level WatermelonDB APIs ",(0,i.kt)("strong",{parentName:"p"},"database adapters"),"."),(0,i.kt)("h2",{id:"currently-supported-databases"},"Currently supported databases"),(0,i.kt)("h3",{id:"sqlite"},"SQLite"),(0,i.kt)("p",null,"Supported frameworks:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"React Native:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Operating systems:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"iOS"),(0,i.kt)("li",{parentName:"ul"},"Android"))),(0,i.kt)("li",{parentName:"ul"},"Implementations:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"JSI adapter"),(0,i.kt)("li",{parentName:"ul"},"New NativeModule (added in 0.26)"),(0,i.kt)("li",{parentName:"ul"},"Legacy NativeModule (deprecated in 0.26)"))))),(0,i.kt)("li",{parentName:"ul"},"NodeJS",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"via ",(0,i.kt)("inlineCode",{parentName:"li"},"better-sqlite3")," - contributed by Sid Ferreira")))),(0,i.kt)("h3",{id:"lokijs"},"LokiJS"),(0,i.kt)("p",null,"Supported frameworks:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Web",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Storage: IndexedDB"))),(0,i.kt)("li",{parentName:"ul"},"NodeJS",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Storage: in-memory only")))),(0,i.kt)("p",null,"Why ",(0,i.kt)("a",{parentName:"p",href:"http://techfort.github.io/LokiJS/"},"LokiJS"),"? WebSQL would be a perfect fit for Watermelon, but sadly is a dead API, so we must use IndexedDB, but its querying capabilities make it unsuitable as a serious database. LokiJS implements a very fast in-memory querying API, using IndexedDB as storage."),(0,i.kt)("h2",{id:"contribute-these-adapters"},"Contribute these adapters!"),(0,i.kt)("p",null,"Please contribute to WatermelonDB. We'd love to support these platforms and databases:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://microsoft.github.io/react-native-windows/"},"React Native for Windows and macOS")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/realm/realm-cpp"},"Realm database")),(0,i.kt)("li",{parentName:"ul"},"SQLite for web (",(0,i.kt)("a",{parentName:"li",href:"https://github.com/sql-js/sql.js/"},"sql.js")," or ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/jlongster/absurd-sql"},"absurd-sql"),")"),(0,i.kt)("li",{parentName:"ul"},"LokiJS NodeJS storage option"),(0,i.kt)("li",{parentName:"ul"},"SQLite for ",(0,i.kt)("a",{parentName:"li",href:"https://www.electronjs.org"},"Electron"),", Tauri, etc."),(0,i.kt)("li",{parentName:"ul"},"SQLite for ",(0,i.kt)("a",{parentName:"li",href:"https://capacitorjs.com"},"Capacitor"))),(0,i.kt)("h2",{id:"adding-new-react-native-operating-systems"},"Adding new React Native operating systems"),(0,i.kt)("p",null,"Thanks to our cross-platform JSI (C++) SQLite adapter, it takes very little code to add support for new React Native platforms (like macOS or Windows)."),(0,i.kt)("p",null,"All you have to do is this:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Compile ",(0,i.kt)("inlineCode",{parentName:"li"},".cpp")," files in ",(0,i.kt)("inlineCode",{parentName:"li"},"native/shared")," folder"),(0,i.kt)("li",{parentName:"ul"},"Link library with ",(0,i.kt)("inlineCode",{parentName:"li"},"sqlite3"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Use system-provided sqlite3 if possible (we do that on iOS)"),(0,i.kt)("li",{parentName:"ul"},"If not, we ship sqlite source code via NPM ",(0,i.kt)("inlineCode",{parentName:"li"},"@nozbe/sqlite")," package. Just add ",(0,i.kt)("inlineCode",{parentName:"li"},"node_modules/@nozbe/sqlite/**")," to search paths and compile ",(0,i.kt)("inlineCode",{parentName:"li"},"node_modules/@nozbe/sqlite/*/sqlite3.c")))),(0,i.kt)("li",{parentName:"ul"},"Provide implementation for ",(0,i.kt)("inlineCode",{parentName:"li"},"native/shared/DatabasePlatform.h"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Please note that most of these functions can remain unimplemented (empty) for basic operation - e.g. you can skip logging, memory, turbo json support"))),(0,i.kt)("li",{parentName:"ul"},"Provide a React Native hook that calls ",(0,i.kt)("inlineCode",{parentName:"li"},"Database::install(jsi::Runtime *)"))),(0,i.kt)("p",null,"Check out ",(0,i.kt)("inlineCode",{parentName:"p"},"native/android-jsi")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"native/ios")," for two implementation examples. You might be able to reuse some code from these, e.g. platform support stubs or ",(0,i.kt)("inlineCode",{parentName:"p"},"CMakeLists.txt"),"."),(0,i.kt)("h2",{id:"adding-new-frameworks-to-sqlite-adapter"},"Adding new frameworks to SQLite adapter"),(0,i.kt)("p",null,"Let's say you want to add support for a new JS+native framework, like Electron, Tauri, NativeScript or Capacitor."),(0,i.kt)("p",null,"This takes more work, but ultimately, given that (iOS, Android, JS, C++, Objective-C, Java) are supported already (just for React Native and Node), you only need to develop the glue code necessary to bridge the gap between ",(0,i.kt)("inlineCode",{parentName:"p"},"src/adapters/sqlite")," JS code, and the native but non-React-Native-specific bits. You'll need some familiarity with the platform you're trying to support, but little WatermelonDB/React Native/C++ familiary will be needed to get this done."),(0,i.kt)("h3",{id:"js-side-glue"},"JS-side glue"),(0,i.kt)("p",null,"The general SQLite implementation is in ",(0,i.kt)("inlineCode",{parentName:"p"},"src/adapters/sqlite/index.js"),". It forwards database calls to ",(0,i.kt)("inlineCode",{parentName:"p"},"this._dispatcher"),". The dispatcher is the JS-side bridge/glue code."),(0,i.kt)("p",null,"See ",(0,i.kt)("inlineCode",{parentName:"p"},"src/adapters/sqlite/makeDispatcher")," to see concrete dispatchers and add your own, depending on the platform's convention of calling native code. For example:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"makeDispatcher/index.js")," (Node JS) just imports more JS code, since native=JS in this case"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"makeDispatcher/index.native.js")," (React Native) calls ",(0,i.kt)("inlineCode",{parentName:"li"},"require('react-native').NativeModules"))),(0,i.kt)("h3",{id:"native-side-glue"},"Native-side glue"),(0,i.kt)("p",null,"Depending on the capabilities of the framework you want to support, there's a few ways to go about this:"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The easy (JS-only) way"),". If your framework has existing SQLite bindings in JavaScript ",(0,i.kt)("strong",{parentName:"p"},"that work synchronously")," (similar to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/WiseLibs/better-sqlite3"},"better-sqlite3")," in Node), you can reuse code in ",(0,i.kt)("inlineCode",{parentName:"p"},"src/adapters/sqlite/sqlite-node")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The Java/Objective-C way"),". If your framework targets iOS, macOS, or Android, and you're terrified of C++, you can reuse the React Native NativeModule implementation."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Look at ",(0,i.kt)("inlineCode",{parentName:"li"},"native/ios/WatermelonDB/objc/WMDatabase.{h,m}")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"WMDatabaseDriver.{h,m}")," for the iOS implementation. These files contain SQLite, WatermelonDB, and iOS-specific logic, but without React Native details. You need to provide an equivalent of ",(0,i.kt)("inlineCode",{parentName:"li"},"WMDatabaseBridge")," (the React Native glue between ",(0,i.kt)("inlineCode",{parentName:"li"},"WMDatabaseDriver")," and JS) for your framework"),(0,i.kt)("li",{parentName:"ul"},"For Android, look at ",(0,i.kt)("inlineCode",{parentName:"li"},"native/android/src/main/java/com/nozbe/watermelondb/WMDatabase.java")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"WMDatabaseDriver.java"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The C++ way"),". The best way is to refactor the React Native C++ JSI module to split off React Native-specific logic and leave a framework-independent core. Doing this way ensures that your port will receive support for new operating systems, and all the new features, as the core React Native module will focus on the C++ implementation in the long term. Contact @radex for guidance about this."),(0,i.kt)("h2",{id:"adding-new-databases"},"Adding new databases"),(0,i.kt)("p",null,"If you want to contribute support to new underlying databases (i.e. not SQL or LokiJS-based), this is a rough sketch of what's required:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A new ",(0,i.kt)("inlineCode",{parentName:"li"},"FoodbAdapter")," that conforms to ",(0,i.kt)("inlineCode",{parentName:"li"},"DatabaseAdapter")," (",(0,i.kt)("inlineCode",{parentName:"li"},"src/adapters/type.js"),"). You can initially skip some method implementations for basic support, most basic are ",(0,i.kt)("inlineCode",{parentName:"li"},"find, query, count, batch"),"."),(0,i.kt)("li",{parentName:"ul"},"Some way to convert WatermelonDB's query language into queries specific for your database. For reference, see:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"src/adapters/sqlite/encodeQuery")," for generating SQL"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"src/adapters/lokijs/worker/encodeQuery")," for generating LokiJS queries + ",(0,i.kt)("inlineCode",{parentName:"li"},"executeQuery")," which executes joins (which Loki does not natively support)")))))}u.isMDXComponent=!0}}]);